# 文件系统实现

本节讨论
- 在磁盘上如何存储和访问文件的有关问题
- 如何组织文件，分配磁盘空间，恢复空闲空间，跟踪数据位置以及其他操作系统部分给外存提供的接口

## 文件系统结构

磁盘的两个特点，使得其成为存储多个文件的方便介质：

- 可以原地重写，即可以从磁盘上读一块，修改该块并将其写会原来的位置
- 可以直接访问磁盘上的任意一块信息，因此可以方便地按顺序或随即访问文件

操作系统通过文件系统来存储、定位和提取数据，来提供对磁盘的高效访问

应用程序 -> 逻辑文件系统 -> 文件组织系统 -> 基本文件系统 -> I/O 控制 -> 设备

- I/O控制：设备驱动程序和中断处理程序，实现内存与磁盘之间的信息传输
- 基本文件系统：物理块
- 文件组织模块：逻辑块和物理块
- 逻辑文件系统：管理元数据

## 文件系统实现

在磁盘上，文件系统包括如下信息：
- 如何启动所存储的操作系统
- 总的块数
- 空闲块的数目和位置
- 目录结构
- 各个具体文件

结构：

- 引导控制块(boot control block)：从改卷引导操作系统所需要的信息。UFS中称为引导块，NTFS中称为分区引导扇区
- 卷控制块(volume control block)：卷的详细信息。UFS中称为超级块，NTFS中存储在主控文件表中
- 每个文件系统的目录文件用来组织文件。UFS中它包含文件名和相关索引节点，NTFS中它存储在主控文件表中
- 每个文件的FCB包括很多改文件的详细信息

内存内信息用于文件系统管理并通过缓存提高性能，包括：

- 一个内存中的安装表，包含所有安装卷的信息
- 一个内存中的目录结构缓存，保存近来访问过的目录信息
- 系统范围内的打开文件表
- 单个进程的打开文件表

### 虚拟文件系统

现代操作系统必须同时支持多个文件系统类型。为了把多个文件系统整合成一个目录结构，以及用户在访问文件系统空间时，可以无缝地在文件系统类型中移动，引入虚拟文件系统的概念

虚拟文件系统(VFS)层有两个作用：

- VFS层通过定义一个清晰的VFS接口，以将文件系统的通用操作和具体实现分开，多个VFS接口的实现可以共存在同一台机器上
- VFS提供了在网络上唯一标识一个文件的机制(vnode)

Linux VFS定义的主要对象类型：

- 索引节点对象(inode object)，表示一个单独的文件
- 文件对象，表示一个打开的文件
- 超级快对象(superblock object)，表示整个文件系统
- 目录条目对象(dentry object)，表示一个单独的目录条目

## 目录实现

目录分配和目录管理算法的选择对文件系统的效率、性能和可靠性有着很大的影响

- 线性列表
- 哈希表

## 分配方法

如何为磁盘上的文件分配空间，以有效地使用磁盘空间和快速访问文件

### 连续分配

每个文件在磁盘上占有一组连续的块

- 为新文件找到空间可能会较慢
- 外部碎片问题
- 创建文件时不一定知道需要多少空间

### 链接分配

每个文件是磁盘块的链表，解决的连续分配的问题

但是存在问题：

- 只能有效地用于文件的顺序访问
- 指针需要额外空间

解决办法为将多个块组成簇(cluster)

另一个问题是指针的可靠性

- 文件分配表(FAT)

### 索引分配

如果不用 FAT，链接分配就不能有效地支持直接访问。而索引分配把所有指针放在一起，通过索引块解决了这个问题

- 每个文件都有其索引块，是一个磁盘块地址的数组
- 索引块的第i个条目指向文件的第i个快，目录条目包含索引块的地址
- 要读第i个快，通过索引块的第i个条目的指针查找和读入所需的块

## 空闲空间管理

为记录空闲磁盘空间，系统需要维护一个空闲空间链表

- 位向量
- 链表
- 组
- 计数


